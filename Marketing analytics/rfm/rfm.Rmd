---
title: "rfm_scholar"
output: html_document
---


```{r}
##sources: MAIN SOURCE: https://cran.r-project.org/web/packages/rfm/vignettes/rfm-customer-level-data.html
##reserve link https://rfm.rsquaredacademy.com/articles/rfm-customer-level-data.html

##Secondary sources:
##https://josepcurtodiaz.gitbooks.io/customer-analytics-with-r/chapter6.html
##https://www.kaggle.com/carrie1/ecommerce-data/downloads/data.csv/report do this in pbi
##https://cran.r-project.org/web/packages/rfm/vignettes/rfm-customer-level-data.html
##https://rpubs.com/hoakevinquach/Customer-Lifetime-Value-CLV
##https://www.panalysis.com/blog/recency-frequency-and-monetary-analysis-using-power-bi


#This is a scholar example of using recency-frequency-monetary analysis

#Preliminary

library(ggplot2)
library(dplyr)
library(DT)
library(rfm)
library(RColorBrewer)
library(caTools)

#Data is got from package

rfm_data_customer

#Data transformation

analysis_date <- lubridate::as_date('2007-01-01', tz = 'UTC') #transform dates

rfm_result <- rfm_table_customer_2(rfm_data_customer, customer_id, number_of_orders, most_recent_visit, revenue, analysis_date) #compose rfm table
rfm_result #print result


#Segmenting


rfm_result_segment <- rfm_table_order(rfm_data_orders, customer_id, order_date,
revenue, analysis_date) #segment data


##rfm_segment function to specify segments

segment_names <- c("Champions", "Loyal Customers", "Potential Loyalist", "New Customers", "Promising", "Need Attention", "About To Sleep", "At Risk", "Can't Lose Them", "Lost")

recency_lower <- c(4, 2, 3, 4, 3, 2, 2, 1, 1, 1)
recency_upper <- c(5, 5, 5, 5, 4, 3, 3, 2, 1, 2)
frequency_lower <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
frequency_upper <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)
monetary_lower <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
monetary_upper <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)

rfmsegment<- rfm_segment(rfm_result_segment, segment_names, recency_lower, recency_upper, frequency_lower, frequency_upper, monetary_lower, monetary_upper)
rfmsegmentable<- datatable(rfmsegment)

##https://github.com/rsquaredacademy/rfm/issues/53


rfmsegment_s<- rfmsegment %>% count(segment) %>% arrange(desc(n)) %>% rename(Segment = segment, Count = n)


#Charts drawing

heatmap<- rfm_heatmap(rfm_result) #draw heatmap
print(heatmap)

rfm_bar<- rfm_bar_chart(rfm_result) #draw bar chart
print(rfm_bar)

rfm_hist<- rfm_histograms(rfm_result) ##relative distribution of monetary value (total revenue generated by each customer); recency days (days since the most recent visit for each customer); frequency (transaction count for each customer)
print(rfm_hist)

#A bit more of data prep for the next graph

rfm_segments_graph <- 
    rfmsegment %>%
    group_by(segment) %>%
    select(segment, amount) %>%
    summarize(median(amount)) %>%
    rename(segment = segment, avg_monetary = `median(amount)`) %>%
    arrange(avg_monetary) 

n_fill <- nrow(rfm_segments_graph)
rfm_segments_graph_pic<- ggplot(rfm_segments_graph, aes(segment, avg_monetary)) +
    geom_bar(stat = "identity", fill = brewer.pal(n = n_fill, name = "Set3")) +
    xlab("Segment") + ylab("Median Monetary Value") +
    ggtitle("Median Monetary Value by Segment") +
    coord_flip() +
    theme(
      plot.title = element_text(hjust = 0.5)
    )

print(rfm_segments_graph_pic)

```

